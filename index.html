<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>Mobile Fast Text Reader</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "sans-serif"] },
          colors: { base: { bg: "#000000", card: "#0b0b0b", edge: "#232323" } }
        }
      },
      darkMode: 'class'
    }
  </script>
  <style>
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    /* iOS full-bleed safe area */
    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    .safe-pt { padding-top: env(safe-area-inset-top); }
    /* Prevent text selection on the display area */
    #display { -webkit-user-select: none; user-select: none; }
  </style>

  <!-- Manifest: injected as a data URL at runtime to keep everything single-file -->
  <link id="manifest-link" rel="manifest" href="data:application/manifest+json,{ }">

  <!-- PDF.js (global build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js" integrity="sha512-hIXbR1r3r6qG9cA4hPYQmWf+SAAeTRzLh3z0M+Qx0e6w2bZtZ7QjD+8V6v3k6pWJ7uT1KI7oU5z0w1+q0w4CNw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- JSZip for EPUB parsing -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body class="bg-base-bg text-white min-h-screen flex flex-col">
  <!-- App Shell -->
  <header class="safe-pt px-4 py-3 border-b border-base-edge bg-base-bg/95 backdrop-blur">
    <div class="max-w-screen-md mx-auto flex items-center justify-between">
      <h1 class="text-lg font-bold tracking-tight">Mobile Fast Text Reader</h1>
      <div class="flex items-center gap-2">
        <button id="btnInstall" class="text-xs px-3 py-1.5 rounded-lg border border-base-edge bg-base-card hover:bg-zinc-900 hidden">Install</button>
        <button id="btnFullscreen" class="text-xs px-3 py-1.5 rounded-lg border border-base-edge bg-base-card hover:bg-zinc-900" title="Fullscreen">Fullscreen</button>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-screen-md mx-auto p-4 pb-24">
      <!-- Display / Player Stage -->
      <section id="stage" class="mb-4">
        <div id="display" class="w-full rounded-2xl bg-base-card border border-base-edge min-h-[40vh] flex items-center justify-center px-4 py-10 active:opacity-90">
          <div id="currentWord" class="font-extrabold tracking-tight text-center leading-none select-none text-[10vw] sm:text-[7vw]"></div>
        </div>
        <p class="text-xs text-zinc-400 mt-2 text-center">Tap to play/pause • Swipe ◀︎ / ▶︎ to step</p>
      </section>

      <!-- Controls -->
      <section class="grid grid-cols-1 gap-3">
        <!-- Transport -->
        <div class="flex items-center gap-3">
          <button id="btnPlay" class="flex-1 px-4 py-3 rounded-xl bg-white text-black font-semibold hover:opacity-90 active:opacity-80">Play</button>
          <button id="btnPause" class="flex-1 px-4 py-3 rounded-xl bg-zinc-800 border border-base-edge hover:bg-zinc-900">Pause</button>
          <span id="posBadge" class="text-xs text-zinc-400 min-w-[4.5rem] text-right">0 / 0</span>
        </div>

        <!-- Speed (WPM) -->
        <div class="p-3 rounded-xl bg-base-card border border-base-edge">
          <div class="flex items-center justify-between mb-2">
            <label class="font-semibold">Speed (WPM)</label>
            <input id="wpmNumber" type="number" min="50" max="1000" step="10" value="300" class="w-24 bg-black border border-base-edge rounded-lg px-2 py-1" />
          </div>
          <input id="wpmSlider" type="range" min="50" max="1000" step="10" value="300" class="w-full" />
        </div>

        <!-- Text Size -->
        <div class="p-3 rounded-xl bg-base-card border border-base-edge">
          <div class="flex items-center justify-between mb-2">
            <label class="font-semibold">Text Size</label>
            <input id="sizeNumber" type="number" min="16" max="160" step="1" value="72" class="w-24 bg-black border border-base-edge rounded-lg px-2 py-1" />
          </div>
          <input id="sizeSlider" type="range" min="16" max="160" step="1" value="72" class="w-full" />
        </div>
      </section>

      <!-- Source Input -->
      <section class="mt-4 p-3 rounded-xl bg-base-card border border-base-edge">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="flex items-center gap-3">
            <label for="fileInput" class="text-sm">Open file:</label>
            <input id="fileInput" type="file" accept=".txt,.pdf,.epub" class="text-sm file:mr-3 file:px-3 file:py-1.5 file:border-0 file:rounded-md file:bg-white file:text-black file:font-medium file:hover:opacity-90" />
          </div>
          <button id="btnUseText" class="px-3 py-2 rounded-lg border border-base-edge bg-zinc-800 hover:bg-zinc-900">Load textarea → Reader</button>
        </div>

        <textarea id="inputText" placeholder="Paste text here, or drag & drop .txt / .pdf / .epub" class="mt-3 w-full h-48 p-3 rounded-lg bg-black border border-base-edge resize-y"></textarea>
      </section>
    </div>
  </main>

  <!-- Bottom bar -->
  <footer class="safe-pb fixed bottom-0 inset-x-0 bg-base-bg/90 backdrop-blur border-t border-base-edge">
    <div class="max-w-screen-md mx-auto px-4 py-2 flex items-center justify-between gap-3">
      <div class="text-xs text-zinc-400">Client-side • No accounts • Offline-capable</div>
      <div class="text-xs text-zinc-500">© <span id="yy"></span> Han KM</div>
    </div>
  </footer>

  <script>
    // ==== Manifest (inline via data URL) ====
    (function attachManifest(){
      const manifest = {
        name: "Mobile Fast Text Reader",
        short_name: "Fast Reader",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#000000",
        theme_color: "#000000",
        icons: [
          { src: "https://placehold.co/192x192/png?text=App", sizes: "192x192", type: "image/png", purpose: "any" },
          { src: "https://placehold.co/512x512/png?text=App", sizes: "512x512", type: "image/png", purpose: "any" },
          { src: "https://placehold.co/512x512/png?text=Mask", sizes: "512x512", type: "image/png", purpose: "maskable" }
        ]
      };
      const href = 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));
      document.getElementById('manifest-link').setAttribute('href', href);
    })();

    // ==== Lightweight Service Worker (single-file) ====
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE = 'mfr-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil((async () => {
            const cache = await caches.open(CACHE);
            try { await cache.addAll(['./']); } catch (e) { /* ignore */ }
            self.skipWaiting();
          })());
        });
        self.addEventListener('activate', (e) => {
          e.waitUntil((async () => {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => k === CACHE ? null : caches.delete(k)));
            self.clients.claim();
          })());
        });
        self.addEventListener('fetch', (event) => {
          const req = event.request;
          if (req.mode === 'navigate') {
            event.respondWith((async () => {
              try { return await fetch(req); } catch (err) {
                const cached = await caches.match('./');
                return cached || Response.error();
              }
            })());
            return;
          }
          event.respondWith((async () => {
            try { return await fetch(req); } catch (err) {
              const cached = await caches.match(req);
              return cached || Response.error();
            }
          })());
        });
      `;
      const swUrl = URL.createObjectURL(new Blob([swCode], { type: 'text/javascript' }));
      navigator.serviceWorker.register(swUrl, { scope: './' }).catch(()=>{});
    }

    // ==== Install prompt UX (optional) ====
    let deferredPrompt;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e; btnInstall.classList.remove('hidden');
    });
    btnInstall?.addEventListener('click', async () => {
      btnInstall.classList.add('hidden');
      try { await deferredPrompt.prompt(); } catch {}
      deferredPrompt = null;
    });

    // ==== PDF.js worker setup ====
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
    }

    // ==== Reader State ====
    const currentWordEl = document.getElementById('currentWord');
    const displayEl = document.getElementById('display');
    const inputText = document.getElementById('inputText');
    const fileInput = document.getElementById('fileInput');
    const btnPlay = document.getElementById('btnPlay');
    const btnPause = document.getElementById('btnPause');
    const posBadge = document.getElementById('posBadge');
    const yy = document.getElementById('yy');
    document.getElementById('yy').textContent = new Date().getFullYear();

    const wpmSlider = document.getElementById('wpmSlider');
    const wpmNumber = document.getElementById('wpmNumber');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeNumber = document.getElementById('sizeNumber');
    const btnUseText = document.getElementById('btnUseText');
    const btnFullscreen = document.getElementById('btnFullscreen');

    let words = [];
    let idx = 0;
    let playing = false;
    let tickHandle = null;

    function sanitizeToWords(text) {
      if (!text) return [];
      text = text.replace(/\u00AD/g, '')                // soft hyphen
                 .replace(/\r\n|\r/g, '\n')           // normalise newlines
                 .replace(/-\n/g, '')                   // hyphenated wrap
                 .replace(/\n+/g, ' ')                  // flatten newlines
                 .replace(/\s+/g, ' ')                  // collapse whitespace
                 .trim();
      return text ? text.split(' ') : [];
    }

    function updatePositionBadge() {
      posBadge.textContent = `${Math.min(idx+1, words.length)} / ${words.length}`;
    }

    function showWord() {
      currentWordEl.textContent = words[idx] || '';
      updatePositionBadge();
    }

    function setWPM(v) {
      const val = Math.max(50, Math.min(1000, Number(v) || 300));
      wpmSlider.value = String(val); wpmNumber.value = String(val);
      if (playing) { stop(); start(); }
    }

    function setFontSize(px) {
      const val = Math.max(16, Math.min(160, Number(px) || 72));
      sizeSlider.value = String(val); sizeNumber.value = String(val);
      currentWordEl.style.fontSize = val + 'px';
    }

    function start() {
      if (playing || words.length === 0) return;
      playing = true;
      btnPlay.classList.add('opacity-60', 'pointer-events-none');
      btnPause.classList.remove('opacity-60', 'pointer-events-none');
      const interval = 60000 / Number(wpmSlider.value || 300);
      tickHandle = setInterval(() => {
        if (idx < words.length - 1) {
          idx++; showWord();
        } else { stop(); }
      }, interval);
    }

    function stop() {
      playing = false;
      btnPlay.classList.remove('opacity-60', 'pointer-events-none');
      btnPause.classList.add('opacity-60', 'pointer-events-none');
      if (tickHandle) { clearInterval(tickHandle); tickHandle = null; }
    }

    function nextWord() { if (idx < words.length - 1) { idx++; showWord(); } }
    function prevWord() { if (idx > 0) { idx--; showWord(); } }

    function loadWordsFromText(text) {
      words = sanitizeToWords(text);
      idx = 0; showWord();
    }

    // === File loaders ===
    async function loadTXT(file) {
      const text = await file.text();
      loadWordsFromText(text);
      inputText.value = text;
    }

    async function loadPDF(file) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let out = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        out += content.items.map(it => it.str).join(' ') + '\n';
      }
      inputText.value = out.trim();
      loadWordsFromText(out);
    }

    async function loadEPUB(file) {
      const ab = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(ab);
      // 1) Find rootfile from META-INF/container.xml
      const containerXML = await zip.file('META-INF/container.xml').async('string').catch(()=>'');
      if (!containerXML) { alert('Invalid EPUB (no container.xml)'); return; }
      const cdoc = new DOMParser().parseFromString(containerXML, 'application/xml');
      const rootPath = cdoc.querySelector('rootfile')?.getAttribute('full-path');
      if (!rootPath) { alert('Invalid EPUB (no rootfile)'); return; }
      const rootDir = rootPath.substring(0, rootPath.lastIndexOf('/') + 1);
      const opf = await zip.file(rootPath).async('string');
      const opfDoc = new DOMParser().parseFromString(opf, 'application/xml');
      const manifest = new Map();
      opfDoc.querySelectorAll('manifest > item').forEach(it => {
        manifest.set(it.getAttribute('id'), it.getAttribute('href'));
      });
      const spineIds = Array.from(opfDoc.querySelectorAll('spine > itemref')).map(n => n.getAttribute('idref'));
      let text = '';
      for (const id of spineIds) {
        const href = manifest.get(id);
        if (!href) continue;
        const path = rootDir + href;
        const file = zip.file(path);
        if (!file) continue;
        const xhtml = await file.async('string');
        const doc = new DOMParser().parseFromString(xhtml, 'text/html');
        // Remove scripts/styles and get body text
        doc.querySelectorAll('script,style,noscript').forEach(el => el.remove());
        const chunk = doc.body?.innerText || '';
        text += '\n' + chunk + '\n';
      }
      text = text.replace(/\n{2,}/g, '\n');
      inputText.value = text.trim();
      loadWordsFromText(text);
    }

    async function handleFile(file) {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      if (ext === 'txt') return loadTXT(file);
      if (ext === 'pdf') return loadPDF(file);
      if (ext === 'epub') return loadEPUB(file);
      // Fallback by MIME
      if (file.type === 'text/plain') return loadTXT(file);
      alert('Unsupported file type: ' + file.name);
    }

    // === UI Events ===
    btnPlay.addEventListener('click', start);
    btnPause.addEventListener('click', stop);

    wpmSlider.addEventListener('input', e => setWPM(e.target.value));
    wpmNumber.addEventListener('input', e => setWPM(e.target.value));
    sizeSlider.addEventListener('input', e => setFontSize(e.target.value));
    sizeNumber.addEventListener('input', e => setFontSize(e.target.value));

    btnUseText.addEventListener('click', () => {
      loadWordsFromText(inputText.value);
    });

    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (f) await handleFile(f);
      e.target.value = '';
    });

    // Drag & drop onto textarea (files only)
    inputText.addEventListener('dragover', (e) => { e.preventDefault(); });
    inputText.addEventListener('drop', async (e) => {
      e.preventDefault();
      const files = e.dataTransfer?.files; if (!files || !files.length) return;
      await handleFile(files[0]);
    });

    // Tap to play/pause, swipe to navigate
    displayEl.addEventListener('click', () => {
      playing ? stop() : start();
    });
    let touchX = null, touchY = null;
    displayEl.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        touchX = e.touches[0].clientX; touchY = e.touches[0].clientY;
      }
    }, { passive: true });
    displayEl.addEventListener('touchend', (e) => {
      if (touchX == null) return;
      const dx = (e.changedTouches[0].clientX - touchX);
      const dy = (e.changedTouches[0].clientY - touchY);
      const TH = 30; // px threshold
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > TH) {
        // Swipe left/right
        stop();
        if (dx < 0) nextWord(); else prevWord();
      } else {
        // Tap
        playing ? stop() : start();
      }
      touchX = touchY = null;
    }, { passive: true });

    // Keyboard quickies (space, arrows, F)
    window.addEventListener('keydown', (e) => {
      if (e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
      if (e.code === 'Space') { e.preventDefault(); playing ? stop() : start(); }
      if (e.code === 'ArrowRight') { stop(); nextWord(); }
      if (e.code === 'ArrowLeft') { stop(); prevWord(); }
      if (e.code === 'KeyF') { toggleFullscreen(); }
    });

    // Fullscreen
    function isFullscreen() { return document.fullscreenElement != null; }
    function toggleFullscreen() {
      const el = document.documentElement; // go immersive
      if (!isFullscreen()) el.requestFullscreen({ navigationUI: 'hide' }).catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    }
    btnFullscreen.addEventListener('click', toggleFullscreen);

    document.addEventListener('fullscreenchange', () => {
      const controls = document.querySelectorAll('header, section.grid, section.mt-4, footer');
      controls.forEach(el => el.classList.toggle('hidden', isFullscreen()));
      document.getElementById('stage').classList.toggle('mt-6', !isFullscreen());
      // Force display background to pure black in fullscreen
      if (isFullscreen()) {
        displayEl.classList.add('bg-black');
      } else {
        displayEl.classList.remove('bg-black');
      }
    });

    // Init defaults
    setWPM(300); setFontSize(72); showWord();
  </script>
</body>
</html>
